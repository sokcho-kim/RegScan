# 작업일지 - 2026-01-31

## 작업 내역

### [RegScan] FDA 파이프라인 완성 및 테스트

#### 1. 환경 설정 완료
- `.env` 파일 생성 및 API 키 설정
  - FDA API 키: `bnBZWNhcTfKsR04Fw5clAltjBAlvleSUsPG0ilkO`
  - 공공데이터포털 API 키 설정
  - 열린국회정보 API 키 설정
  - OpenAI API 키 설정
- `settings.py` 업데이트: 새 환경변수 필드 추가
  - `DATA_GO_KR_API_KEY`, `OPEN_ASSEMBLY_API_KEY`, `LOG_LEVEL`

#### 2. FDA 파이프라인 버그 수정
- **URL 인코딩 문제 해결** (`regscan/ingest/fda.py:82`)
  - `urlencode()`가 `+`를 `%2B`로 변환 → FDA API 500 에러 발생
  - `urlencode(params, safe='[]+ ')`로 수정하여 해결

#### 3. FDA 파이프라인 전체 테스트 성공
```
수집: 41건 (최근 7일)
파싱: 41건
변환: 41건 (FeedCard 생성)
```

| 영향도 | 건수 |
|--------|------|
| HIGH | 16건 |
| MID | 25건 |
| LOW | 0건 |

#### 4. 수집 방식 결정
- **Playwright 사용** (모든 수집기 공통 원칙)
- FDA: openFDA API 사용 (예외적으로 API 제공됨)
- MOHW, HIRA: Playwright 크롤링 예정

---

## 현재 파이프라인 구조

```
[수집] FDAApprovalIngestor.fetch()
   ↓ raw API 응답 (41건)
[파싱] FDADrugParser.parse_many()
   ↓ 정규화된 dict
[변환] SignalGenerator.generate()
   ↓ FeedCard 객체
[저장] FeedCardRepository (미테스트)
   ↓ SQLite DB
```

### 영향도 평가 로직 (현재: 규칙 기반)

| 영향도 | 조건 |
|--------|------|
| HIGH | 신약(ORIG), 희귀의약품(orphan), Priority Review(class 1,2) |
| MID | 적응증 추가(SUPPL), 항암제(cancer, oncolog) |
| LOW | 그 외 |

---

## 고도화 방안

### 1. 영향도 평가 개선
- **현재**: 규칙 기반 (submission_type, pharm_class 키워드 매칭)
- **개선안**:
  - LLM 기반 평가: 약물 특성, 시장 규모, 경쟁 약물 고려
  - ML 모델: 과거 데이터 기반 영향도 예측
  - 한국 시장 연계: 국내 허가 여부, 급여 가능성 반영

### 2. why_it_matters 생성 개선
- **현재**: 템플릿 기반 (15개 템플릿) + LLM 폴백
- **개선안**:
  - 한국 보험/심사 맥락 반영
  - 유사 약물 국내 급여 사례 참조
  - 역할별(PHYSICIAN, PHARMACIST, ADMIN) 맞춤 메시지

### 3. 데이터 소스 확장

#### MOHW 수집기 구현 계획 (Playwright)

| 데이터 | 사이트 | URL | 비고 |
|--------|--------|-----|------|
| 복지부 고시 | 법령정보센터 | https://www.law.go.kr | 건강보험/약제급여/요양급여 검색 |
| 행정예고 | 입법예고시스템 | https://www.lawmaking.go.kr | 보건복지부 필터, 의견제출 기한 |
| 복지부 공지 | 복지부 공식 | https://www.mohw.go.kr | 보도자료, 공지사항 |

**구현 순서:**
1. 사이트 구조 파악 (셀렉터, 페이지네이션)
2. Playwright 크롤러 작성
3. 파서 구현 (FDADrugParser 참고)
4. SignalGenerator 확장 (MOHW용 change_type, impact_level 로직)

#### HIRA 수집기 구현 계획 (Playwright)
- [ ] 공지사항, 심사지침 크롤링
- 사이트: https://www.hira.or.kr

### 4. 파이프라인 고도화
- [ ] 중복 제거: source_id 기반 upsert
- [ ] 스케줄링: 일일 배치 자동화 (cron/Task Scheduler)
- [ ] 알림: 신규 HIGH 영향도 카드 Slack/Email 알림

### 5. 품질 관리
- [ ] 테스트 커버리지 확대
- [ ] 파싱 실패 건 로깅 및 재처리
- [ ] 데이터 품질 모니터링 대시보드

---

## 다음 할 일
- [x] .env 파일에 FDA API 키 설정
- [x] FDA 파이프라인 실제 테스트 실행
- [ ] DB 저장 테스트 (FeedCardRepository)
- [ ] MOHW 수집기 Playwright 기반 구현
- [ ] HIRA 수집기 Playwright 기반 구현

---

## 이슈
- FDA API 키 복사 시 주의: `B`와 `P` 혼동 주의
- OpenAI API 키 `.env` 입력 시 중복 방지: `OPENAI_API_KEY= OPENAI_API_KEY=...` 형태 오류 발생
