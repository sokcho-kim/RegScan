# 작업일지 - 2026-02-12

## 작업 내역

### v3.0 3-Stream 전체 실행 + 주요 버그 수정

어제까지 구현한 3-Stream 아키텍처를 실제 실행하면서 발견된 문제들을 모두 수정하고, 전체 동시 실행까지 검증 완료.

#### 1. DB 스키마 마이그레이션
- `create_all()`은 기존 테이블에 컬럼을 추가하지 않음
- ALTER TABLE로 수동 추가: `drugs.korea_relevance_score`, `therapeutic_areas`, `stream_sources`, `first_seen_at`, `regulatory_events.created_at`

#### 2. FDA EPC 용어 전면 교체
- 가상 EPC 용어 → 실제 FDA API에 존재하는 값으로 교체 (5개 영역 전부)
- 방법: pembrolizumab, trastuzumab 등 실제 약물 조회해서 EPC 값 역추출
- 결과: 200 OK 비율 2/20 → 36/39

| 영역 | 변경 전 → 후 | 효과 |
|------|-------------|------|
| 항암 | 20개 가상 → 12개 실제 | 12/12 성공 |
| 면역 | 11개 가상 → 10개 실제 | 10/10 성공 |
| 심혈관 | 13개 가상 → 8개 실제 | 7/8 성공 |
| 대사 | 10개 가상 → 5개 실제 | 4/5 성공 |
| 희귀질환 | 7개 가상 → 4개 실제 | 3/4 성공 |

#### 3. EMA JSON 필드명 수정
- EMA가 camelCase → snake_case로 형식 변경된 상태였음
- `therapeuticArea` → `therapeutic_area_mesh` + `pharmacotherapeutic_group_human` 결합
- `activeSubstance` → `active_substance` + `international_non_proprietary_name_common_name` 폴백
- 결과: EMA 0건 → 258건 (항암 기준)

#### 4. ClinicalTrials.gov 403 해결
- **원인**: httpx 기본 User-Agent(`python-httpx/0.x`)가 CT.gov WAF에 차단됨
- **수정**: `User-Agent: RegScan/3.0 (Python aiohttp/3.12)` 헤더 추가
- **추가**: `query.term` + AREA 구문 → `query.cond` 전용 파라미터 + `filter.advanced` 분리
- 결과: 0건 → 163건 (38개 condition 전부 200 OK)
- **파일**: `regscan/ingest/clinicaltrials.py`

#### 5. Innovation Stream EMA 필드명 수정
- EMA PRIME: `primeMedicine` → `prime_priority_medicine` 추가
- EMA Conditional: `conditionalApproval` → `conditional_approval` 추가
- 결과: PRIME 0→46건, Conditional 0→59건
- **파일**: `regscan/stream/innovation.py`

#### 6. 전체 3-Stream 동시 실행 성공

```
python -m regscan.batch.pipeline  (플래그 없이)
```

| 스트림 | 수집 | DB 저장 | 시간 |
|--------|------|---------|------|
| Stream 1 (치료영역 5개) | 641 약물 | — | ~30초/영역 |
| Stream 2 (혁신지표) | 2,368 약물 | — | 7초 |
| Stream 3 (외부시그널) | 248 약물 | — | 19초 |
| 병합 | 2,979 고유 약물 | 633건 (score≥10) | — |
| 브리핑 | 8건 생성 | — | ~80초 |
| **전체** | — | **633건, 73건 변경** | **135.6초** |

### 주기별 브리핑 데이터량 실측

매일 브리핑할 만한 데이터가 나오는지 검증하기 위해 실제 API를 날짜 구간별로 쿼리.

| 소스 | 주 2회 (3~4일) | 주 1회 (7일) |
|------|---------------|-------------|
| FDA 승인 | ~3건 (대부분 제네릭) | ~20건 |
| CT.gov Phase 3 | ~1건 | ~1건 |
| medRxiv 매칭 | ~9건 | ~8건 |
| EMA | ~0건 | ~0건 |
| **합계** | **~13건** | **~29건** |

양쪽 시나리오 모두 LLM이 "주요 변동 없음" 판정 — **데이터 소스 보강 필요**.

- **결과물**: `output/sample_briefing_biweekly.md`, `output/sample_briefing_weekly.md`

---

## 이슈

### 해결됨
- [x] DB 스키마 불일치 (`no such column`) → ALTER TABLE로 해결
- [x] FDA EPC 404 (18/20 용어) → 실제 값으로 교체
- [x] EMA 0건 → snake_case 필드명 폴백 추가
- [x] CT.gov 403 Forbidden → User-Agent + query 형식 수정
- [x] EMA PRIME/Conditional 0건 → 필드명 수정

### 미해결
- FDA Breakthrough (code 5) 검색 계속 404 — 코드 형식 확인 필요
- `therapeutic_areas`, `stream_sources` 필드가 DB에 실제 기록되지 않음 (DBLoader 수정 필요)
- Stream 3 약물이 기존 DB와 INN 매칭 안 돼서 저장 0건

---

## 다음 할 일

### 주 1회 브리핑 보강을 위한 데이터 소스 추가
현재 소스만으로는 주간 브리핑이 빈약. 아래 소스 추가 검토:
- [ ] FDA 라벨 변경 / Safety Alert / Boxed Warning
- [ ] FDA Advisory Committee 회의록
- [ ] MFDS (식약처) 허가/변경사항 크롤링
- [ ] 뉴스/프레스릴리즈 (제약사 공시)
- [ ] PDUFA D-day 카운트다운 실데이터 입력

### 기타
- [ ] FDA Breakthrough 404 원인 조사
- [ ] DBLoader에서 therapeutic_areas/stream_sources 반영
- [ ] Stream 3 ↔ 기존 DB 교차 매칭 로직 개선
