# 작업일지 - 2026-02-04

## 오늘의 목표

### 1. MFDS 허가 현황 연동
- [x] 공공데이터포털 API 조사
- [x] nedrug.mfds.go.kr 구조 분석
- [x] `regscan/ingest/mfds.py` 수집기 구현
- [x] `regscan/parse/mfds_parser.py` 파서 구현
- [x] GlobalRegulatoryStatus에 MFDS 통합
- [x] EMA ↔ MFDS 성분 매칭 테스트 (79건 매칭 성공)

### 2. CRIS 임상시험 연동
- [x] cris.nih.go.kr 구조 분석
- [x] 공공데이터포털 API 확인
- [x] `regscan/ingest/cris.py` 수집기 구현
- [x] `regscan/parse/cris_parser.py` 파서 구현
- [x] **CRIS API 연동 완료** (11,547건)

### 3. 전체 통합 테스트
- [x] FDA + EMA + MFDS + CRIS 통합
- [x] 국내 영향 분석 로직 구현
- [x] 통합 테스트 성공

---

## 작업 내역

### 1. MFDS API 연동 (완료)

| 항목 | 내용 |
|------|------|
| API | 식품의약품안전처_의약품 제품 허가정보 |
| 엔드포인트 | `apis.data.go.kr/1471000/DrugPrdtPrmsnInfoService07` |
| 데이터 | 44,035건 |
| 수집 | 5,000건 샘플 |

### 2. CRIS API 연동 (완료)

| 항목 | 내용 |
|------|------|
| API | 질병관리청_임상연구 DB |
| 엔드포인트 | `apis.data.go.kr/1352159/crisinfodataview` |
| 데이터 | 11,547건 |
| 수집 | 500건 샘플 |
| 라이선스 | 공공누리 제2유형 (상업적 이용 금지) |

### 3. 전체 통합 테스트 결과 (완료)

**GlobalRegulatoryStatus 생성**
```
입력: FDA 1,462건 + EMA 2,655건 + MFDS 5,000건
출력: 3,395건 GlobalRegulatoryStatus

├── FDA + EMA: 347건
├── EMA + MFDS: 79건
├── FDA + EMA + MFDS: 1건 (BUDESONIDE)
└── 단일 기관: 나머지
```

**핫이슈 스코어 분포**
| 등급 | 건수 | 예시 |
|------|------|------|
| HIGH | 4건 | Seladelpar(65), Polatuzumab(60), Zanidatamab(60), Budesonide(60) |
| MID | 63건 | |
| LOW | 3,328건 | |

**국내 영향 분석**
| 분류 | 건수 | 설명 |
|------|------|------|
| **국내 도입 임박** | **3건** | FDA/EMA 승인 + MFDS 미허가 + CRIS 임상 진행 |
| 국내 도입 불투명 | 1,846건 | FDA/EMA 승인 + MFDS 미허가 + CRIS 없음 |
| 국내 가용 | 1,546건 | MFDS 허가됨 |

**국내 도입 임박 약물**
| 약물 | 글로벌 승인 | CRIS 임상 |
|------|------------|----------|
| USTEKINUMAB | FDA 2025-11-03 | 크론병 임상 |
| SEMAGLUTIDE | FDA+EMA | 당뇨/비만 임상 |
| osimertinib | EMA 2016-02-01 | 폐암 임상 |

### 4. 구현 파일

| 파일 | 설명 |
|------|------|
| `regscan/ingest/mfds.py` | MFDS 수집기 |
| `regscan/ingest/cris.py` | CRIS 수집기 |
| `regscan/parse/mfds_parser.py` | MFDS 파서 |
| `regscan/parse/cris_parser.py` | CRIS 파서 |
| `regscan/map/global_status.py` | MFDS 통합, merge_global_status() |
| `scripts/test_full_integration.py` | 전체 통합 테스트 |

### 5. 수집 데이터

```
data/
├── fda/approvals_20260203.json      # 1,462건
├── ema/medicines_20260203.json      # 2,655건
├── mfds/permits_20260203.json       # 5,000건
└── cris/trials_20260203.json        # 500건
```

---

### 6. 서버 구축 제안서 작성 (완료)

| 파일 | 설명 |
|------|------|
| `docs/proposal/regscan_server_proposal.qmd` | Quarto PPT (6장) |
| `docs/proposal/regscan_server_proposal.html` | 렌더링 결과 |
| `docs/proposal/dashboard_mockup.html` | 목록 화면 시안 |
| `docs/proposal/report_mockup.html` | 브리핑 리포트 시안 |
| `docs/proposal/gcp_cloud_run_spec.md` | GCP 리소스 요청서 |
| `docs/design/llm_report_generation.md` | LLM 리포트 생성 설계 문서 |

**PPT 구성**
1. 프로젝트 개요
2. 작업 계획
3. 필요 자원 (Cloud Run $10/월)
4. 시안: 목록 화면
5. 시안: 브리핑 리포트
6. 데이터 수집 상세

---

### 7. CRIS 전체 수집 (완료)

| 항목 | 내용 |
|------|------|
| 수집 건수 | 11,551건 |
| 파일 | `data/cris/trials_full_20260204.json` |

### 8. HIRA 데이터 수집 및 변환 (완료)

| 파일 | 건수 | 용량 |
|------|------|------|
| 적용약가파일 (원본) | 59,004 | 9.7MB |
| 수가반영내역 (원본) | 413,400 | 12.7MB |
| `drug_prices_20260204.json` | 59,004 | 62.7MB |
| `medical_fees_20260204.json` | 413,400 | 344MB |

문서: `docs/research/2026-02-04_hira_data_research.md`

### 9. MFDS ↔ HIRA 매칭 테스트 (실패)

**실패 원인: 코드 체계 상이**

| 항목 | MFDS | HIRA |
|------|------|------|
| 코드명 | ITEM_SEQ | 품목코드 |
| 형식 | 195500005 | 050100010 |
| 체계 | 완전히 다름 | 완전히 다름 |

**시도한 매칭 방식**
| 방식 | 결과 | 비고 |
|------|------|------|
| 품목코드 직접 매칭 | 0건 | 코드 체계 상이 |
| 품목명 정규화 | 26,413건 | 신뢰도 낮음 |
| 브랜드명 매칭 | 19,659건 | 신뢰도 낮음 |
| 성분명(INN) 매칭 | 부분 성공 | 정규화 한계 |

**결론**
- 단순 매칭 불가
- 식약처(MFDS)와 심평원(HIRA) 코드 체계 조사 필요
- 공식 코드 매핑 테이블 또는 표준 코드(KD코드, EDI코드 등) 활용 필요

---

## 다음 할 일

### 내일 (02-05)
- [x] ~~MFDS 전체 수집 (44,035건)~~ (완료)
- [x] ~~CRIS 전체 수집 (11,547건)~~ (완료)
- [x] ~~식약처-심평원 코드 체계 조사~~ (완료, 품목기준코드 경유)
- [x] ~~MFDS-HIRA 매칭 실험~~ (완료, 61.6% 성공)
- [ ] **제품코드 직접 매칭 추가** (매칭률 개선)
- [ ] DomesticImpactAnalyzer 클래스 정식 구현
- [ ] Dockerfile 작성
- [ ] Cloud Run 배포

### 이번 주
- [x] ~~HIRA 급여목록 수집~~ (완료)
- [x] ~~MFDS-HIRA 코드 매핑 방안 확정~~ (품목기준코드 경유, 61.6%)
- [ ] 스케줄러 설정
- [ ] FastAPI 엔드포인트

### 추후 진행
- [ ] LLM 브리핑 리포트 자동 생성 (`docs/design/llm_report_generation.md` 참고)
- [ ] 메드클레임 시사점 자동 분석 (MFDS-HIRA 코드 매핑 해결 후)

---

## 메모

- MFDS 성분명(ITEM_INGR_NAME)은 영문으로 저장됨 → INN 매칭 가능
- CRIS API 응답은 `body` 없이 바로 `items` 반환 (파서 수정함)
- 공공누리 제2유형 = 상업적 이용 금지 (CRIS)
- 공공누리 제1유형/제한없음 = 상업적 이용 가능 (MFDS, FDA, EMA)

### MFDS-HIRA 매칭 실패 → 해결 방안 발견

**1차 시도 실패:**
- MFDS ITEM_SEQ ≠ HIRA 품목코드 (체계 상이)
- 품목명/브랜드명 매칭은 신뢰도 낮음

**해결 방안 (scrape-hub 기존 데이터 활용):**
- `ATC코드_매핑_목록.csv` → 브릿지 테이블
- `주성분코드` ↔ `ATC코드 명칭(INN)` 연결
- MFDS INN → 주성분코드 → HIRA 급여여부 조회 가능

**복사한 데이터:**
```
data/bridge/
├── 건강보험심사평가원_ATC코드_매핑_목록_20250630.csv (2.4MB, 21,953건)
└── drug_dictionary_normalized.json (80MB, 91,706건)
```

**계획서:** `docs/design/mfds_hira_matching_plan.md`

---

### 10. MFDS ↔ HIRA 매칭 실험 (성공)

**매칭 전략: 품목기준코드 경유**
```
MFDS ITEM_SEQ → 약가마스터 품목기준코드 → 일반명코드 → HIRA ingredient_code
```

**매칭 결과 (44,035건 MFDS 기준)**

| 항목 | 건수 | 비율 |
|------|------|------|
| 품목기준코드 매칭 | 29,035 | 65.9% |
| **HIRA 급여 연결** | **27,116** | **61.6%** |

**급여 현황 분포**

| 상태 | 건수 | 비율 |
|------|------|------|
| 급여 | 17,323 | 39.3% |
| 미연결 | 16,919 | 38.4% |
| 삭제 | 9,769 | 22.2% |
| 기타 | 24 | 0.1% |

**글로벌 핵심 약물 급여 확인**

| 약물 | 의성분코드 | 급여상태 | 상한가 |
|------|----------|---------|-------|
| pembrolizumab | 639001BIJ | 급여 | ₩2,103,620 |
| nivolumab | 638403BIJ | 급여 | ₩2,534,904 |
| adalimumab | 488430BIJ | 급여 | ₩243,495 |
| trastuzumab | 242802BIJ | 급여 | ₩278,612 |
| bevacizumab | 554331BIJ | 급여 | ₩670,448 |
| rituximab | 422603BIJ | 급여 | ₩1,447,953 |
| osimertinib | 652502ATB | 급여 | ₩190,123 |
| semaglutide | - | **미매칭** | - |

**한계점**
- 약가마스터 일반명코드 55% 비어있음 → 매칭률 제한
- semaglutide 등 신약은 ATC 매핑에 미등재

**실험 스크립트:** `scripts/experiment_matching_v4.py`
**결과 파일:** `data/matching_results_v4_20260204.json`

---

### 11. MFDS ↔ HIRA 매칭 실험 v5 (의약품주성분 마스터)

**핵심 발견:**
- 기존 "의약품표준코드" 데이터는 일반명코드가 45% 비어있음
- **"의약품주성분" 마스터** (data.go.kr/15067461)가 실제 일반명코드 원본
- HIRA 의성분코드 9,002개 중 99.6% (8,962개) 커버

**매칭 결과 (44,035건 MFDS 기준)**

| 매칭 방법 | 건수 | 비율 |
|----------|------|------|
| ingredient_master_exact | 24,413 | 55.4% |
| ingredient_master_normalized | 2,738 | 6.2% |
| atc_mapping | 467 | 1.1% |
| **HIRA 연결 합계** | **27,618** | **62.7%** |
| 미연결 | 16,417 | 37.3% |

**급여 현황**

| 상태 | 건수 | 비율 |
|------|------|------|
| 급여 | 13,227 | 30.0% |
| 삭제 | 14,364 | 32.6% |
| 미연결 | 16,417 | 37.3% |

**글로벌 핵심 약물 (v4 대비 개선)**

| 약물 | v4 | v5 | 상한가 |
|------|----|----|-------|
| pembrolizumab | 급여 | 급여 | ₩2,103,620 |
| nivolumab | 급여 | 급여 | ₩2,534,904 |
| **semaglutide** | **미매칭** | **급여** | ₩73,528 |
| trastuzumab | 급여 | 급여 | ₩5,914,418 |
| atezolizumab | - | 급여 | ₩2,261,034 |
| durvalumab | - | 급여 | ₩3,050,975 |

**추가 데이터:** `data/bridge/yakga_ingredient_master.csv` (59,631건)
**실험 스크립트:** `scripts/experiment_matching_v5.py`
**결과 파일:** `data/matching_results_v5_20260204.json`

---

### 12. MFDS ↔ HIRA 매칭 실험 v6 (정규화 개선)

**정규화 추가:**
- 괄호 제거: `(as amlodipine)` → 제거
- 수화물 제거: `trihydrate`, `dihydrate` 등

**매칭 결과 (최종)**

| 버전 | 매칭 건수 | 매칭률 |
|------|----------|--------|
| v5 | 27,618 | 62.7% |
| **v6** | **33,194** | **75.4%** |

**미연결 10,841건 (24.6%) 분석:**

| 원인 | 비율 | 해결 가능 |
|------|------|----------|
| 한약재/생약 | 46% | X (급여 대상 아님) |
| 비급여 양약 (Tadalafil 등) | 20% | X (급여 대상 아님) |
| 화합물 차이 (HCl vs diHCl) | 10% | X (오매칭 위험) |
| 마스터 미등재 | 15% | X |
| 기타 | 9% | - |

**Tadalafil 사례:**
- 마스터에 코드 14개 있으나 전부 HIRA 미등재
- 발기부전 치료제 = 비급여
- 매칭 로직 문제 아님

**결론:** 75.4%가 현실적 최대치. 나머지는 급여 대상 아니거나 데이터 한계.

**최종 리포트:** `docs/research/2026-02-04_matching_experiment_final_report.md`
**실험 스크립트:** `scripts/experiment_matching_v6.py`
**결과 파일:** `data/matching_results_v6_20260204.json`

---

### 13. MFDS ↔ HIRA 매칭 프로덕션 코드 구현 (완료)

**v6 실험 결과를 프로덕션 코드로 구현**

**새 모듈: `regscan/map/ingredient_bridge.py`**

| 클래스/함수 | 설명 |
|------------|------|
| `IngredientBridge` | 의약품주성분 마스터 기반 MFDS ↔ HIRA 브릿지 |
| `HIRAReimbursementInfo` | HIRA 급여 정보 데이터클래스 |
| `ReimbursementStatus` | 급여 상태 Enum (급여/삭제/비급여/미발견/한약재) |
| `normalize_ingredient_name()` | 성분명 정규화 함수 |
| `is_herbal_ingredient()` | 한약재/생약 감지 함수 |
| `lookup_hira_reimbursement()` | 편의 함수 (성분명 → 급여정보) |

**테스트 결과:**
```
전체 MFDS: 44,035건
HIRA 연결: 33,341건 (75.7%)

상태별:
  급여: 17,996건 (40.9%)
  삭제: 15,345건 (34.8%)
  비급여: 3,856건 (8.8%)
  미발견: 3,476건 (7.9%)
  한약재: 3,362건 (7.6%)
```

**GlobalRegulatoryStatus 통합:**
- `hira_reimbursement: HIRAReimbursementInfo` 필드 추가
- `is_hira_reimbursed` 프로퍼티 추가
- `enrich_with_hira()` 함수 추가

**파일:**
| 파일 | 설명 |
|------|------|
| `regscan/map/ingredient_bridge.py` | 브릿지 모듈 |
| `regscan/map/global_status.py` | HIRA 통합 |
| `scripts/test_ingredient_bridge.py` | 테스트 스크립트 |

**사용 예시:**
```python
from regscan.map import lookup_hira_reimbursement, ReimbursementStatus

info = lookup_hira_reimbursement("Pembrolizumab")
print(info.status)  # ReimbursementStatus.REIMBURSED
print(info.price_ceiling)  # 2,103,620.0
```

---

### 14. FastAPI 엔드포인트 구현 (완료)

**전체 API 테스트 통과:**

| 엔드포인트 | 상태 | 비고 |
|-----------|------|------|
| GET / | OK | API 상태 |
| GET /health | OK | 7,469 drugs 로드 |
| GET /api/v1/stats | OK | FDA 1,462 / EMA 2,655 / MFDS 44,035 / CRIS 11,551 |
| GET /api/v1/hot-issues | OK | 17건 (score >= 60) |
| GET /api/v1/imminent | OK | 16건 (글로벌 승인 + 국내 미허가 + 임상 진행) |
| GET /api/v1/drugs/{inn} | OK | 약물 상세 |
| GET /api/v1/drugs/{inn}/medclaim | OK | 메드클레임 시사점 |
| GET /api/v1/drugs/search | OK | INN 검색 |

**이슈 해결:** NaN JSON 직렬화 오류
- `/api/v1/imminent`에서 `hira_price` NaN 값 → JSON 오류
- Pydantic validator 추가하여 NaN → None 변환
- 수정 파일: `regscan/api/schemas.py`

**결과물:** `regscan/api/` 디렉토리

---

### 15. 프로젝트 폴더 정리 (완료)

**정리 내역:**

| 작업 | Before | After |
|------|--------|-------|
| 실험 스크립트 | `scripts/experiment_matching_v*.py` 6개 | `scripts/archive/`로 이동 |
| 임시 데이터 | `data/*.txt`, `data/*.db` 23개 | `data/archive/`로 이동 |
| worklog 중복 | `./worklog/`, `./docs/worklog/` | `./docs/worklog/`로 통합 |
| analysis 폴더 | `./analysis/` | `./docs/analysis/`로 병합 |

**최종 구조:**
```
RegScan/
├── regscan/           # 메인 패키지
├── data/              # 데이터 (archive/ 하위 정리)
├── scripts/           # 스크립트 (archive/ 하위 정리)
├── docs/              # 문서 통합
│   ├── worklog/       # 작업일지
│   ├── research/      # 리서치
│   ├── design/        # 설계
│   └── analysis/      # 초기 분석
└── tests/             # 테스트
```

**README.md 업데이트 완료**

---

### 16. LLM 브리핑 리포트 구현 (완료)

**새 모듈:**

| 파일 | 설명 |
|------|------|
| `regscan/report/prompts.py` | LLM 프롬프트 템플릿 |
| `regscan/report/llm_generator.py` | LLM 기반 브리핑 생성기 |
| `scripts/test_briefing.py` | 브리핑 테스트 스크립트 |

**API 엔드포인트:**
```
GET /api/v1/drugs/{inn}/briefing?use_llm=true|false
```

**기능:**
- `use_llm=true`: OpenAI/Anthropic LLM으로 자연어 브리핑 생성
- `use_llm=false`: 템플릿 기반 폴백 리포트

**테스트 결과 (pembrolizumab):**
```
Headline: FDA·EMA 동시 승인 pembrolizumab, 국내 급여 적용 중
Subtitle: 다양한 암 치료에 대한 임상 연구로 주목받는 약물

Key Points:
  1. FDA 2025년 11월 승인, EMA 2015년 7월 승인
  2. 희귀의약품/획기적 치료제 지정 정보 없음
  3. MFDS 2015년 3월 허가, HIRA 급여 적용 중
  4. 급여 적용 시 본인부담금 약 63만원(30%)

Medclaim: 급여 적용 약물, 고가약제 이슈 우려
```

**출력 형식:**
- JSON 응답 (API)
- Markdown 형식 (리포트 전문)

---

### 17. 프롬프트 엔지니어링 개선 (완료)

**적용 기법** (Prompt-Engineering-Guide 참고):
- **Few-Shot**: 급여 약물 / 미허가 약물 예시 2개 제공
- **Chain-of-Thought**: 4단계 분석 프레임워크
- **도메인 지식 주입**: 급여 정책 (30%/10%/5%), 고가약제 기준

**모델 비교 테스트:**

| 모델 | 시간 | 품질 | 비고 |
|------|------|------|------|
| gpt-4o-mini | 6~10초 | 좋음 | 비용 효율적 |
| gpt-4o | 8~10초 | 좋음 | 문장 자연스러움 |
| o1-mini | - | - | 접근 권한 필요 |

**개선 효과:**
- Before: placeholder 출력 (`"핵심 포인트 1 (글로벌 승인 현황)"`)
- After: 구체적 내용 (`"FDA 승인 2025년, 본인부담 약 63만원(30%)"`)

**결과물:**
- `regscan/report/prompts.py` - Few-Shot + CoT 프롬프트
- `scripts/compare_models.py` - 모델 비교 스크립트

---

## 오늘 최종 요약

### 신규 구현
| 모듈 | 파일 | 설명 |
|------|------|------|
| API | `regscan/api/*` | FastAPI 엔드포인트 8개 |
| 브릿지 | `regscan/map/ingredient_bridge.py` | MFDS↔HIRA 매칭 (75.7%) |
| 분석기 | `regscan/scan/domestic.py` | 국내 영향 분석 |
| 리포트 | `regscan/report/llm_generator.py` | LLM 브리핑 생성 |
| 프롬프트 | `regscan/report/prompts.py` | Few-Shot + CoT |

### 폴더 정리
- `analysis/` → `docs/analysis/` 병합
- `worklog/` → `docs/worklog/` 통합
- `scripts/experiment_*.py` → `scripts/archive/`
- `data/*.db, *.txt` → `data/archive/`

### API 현황
```
GET /api/v1/stats
GET /api/v1/hot-issues
GET /api/v1/imminent
GET /api/v1/drugs
GET /api/v1/drugs/search
GET /api/v1/drugs/{inn}
GET /api/v1/drugs/{inn}/medclaim
GET /api/v1/drugs/{inn}/briefing  ← NEW (LLM)
```
