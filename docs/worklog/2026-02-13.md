# 작업일지 - 2026-02-13

## 작업 내역

### 3-Model 브리핑 비교 (GPT-4o-mini / GPT-5 / Gemini)

- `regscan/report/llm_generator.py`에 Gemini 프로바이더 추가 (google.genai SDK)
- `regscan/stream/briefing.py`에 Gemini 3번째 폴백 추가
- `regscan/scripts/compare_models.py` 신규 생성 — 동일 약물 3모델 비교 스크립트
- GPT-5 `max_tokens` → `max_completion_tokens` 파라미터 분기 처리
- **결과물**: `output/model_comparison/comparison_20260213_1353.json`

| 모델 | 결과 |
|------|------|
| GPT-4o-mini | 5/5 성공, JSON 파싱 정상, 한글 헤드라인 양호 |
| GPT-5 | 5/5 호출 성공, JSON 파싱 실패 (raw text fallback) |
| Gemini | 0/5 — 429 Quota Exceeded (무료 티어 한도=0) |

### 기사 발행 파이프라인

- `regscan/scripts/publish_articles.py` 신규 생성
- DB 상위 약물 → LLM 브리핑 → JSON + HTML + 인덱스 자동 생성
- **결과물**: `output/briefings/` 18건 HTML 기사 + `index.html` + `hot_issues_2026-02-13.json`

---

## 이슈: FDA 교차참조 누락 (Critical)

### 증상

기사 발행 결과, **score >= 40 상위 약물 16건 중 FDA 승인 정보 전부 누락**. 헤드라인이 "FDA 미승인"으로 출력됨. tisagenlecleucel(Kymriah), axicabtagene ciloleucel(Yescarta) 등 실제 FDA 승인 약물임에도 미승인으로 표시.

### DB 현황

```
총 약물: 700건
이벤트: fda=217 (31%), ema=453 (65%), mfds=71 (10%)
EMA만 있고 FDA 없는 약물: 366건 (52%)
```

| 지표 | 값 | 비율 |
|------|-----|------|
| FDA 이벤트 보유 | 217/700 | 31.0% |
| EMA 이벤트 보유 | 453/700 | 64.7% |
| EMA만, FDA 없음 | 366건 | 교차참조 대상 |
| score>=40 FDA 누락 | 16/18건 | **88.9%** |
| 승인 날짜 있음 (FDA) | 12/217 | 5.5% |
| 승인 날짜 있음 (EMA) | 12/453 | 2.6% |

### 근본 원인

**Stream 1 (Therapeutic) FDA 검색이 `pharm_class_epc`(약리학적 분류)만 사용**

```
therapeutic.py:321 → client.search_by_pharm_class(term, limit=100)
```

openFDA의 `pharm_class_epc` 필드는 약리학적 효과 분류(예: "Kinase Inhibitor")이다. CAR-T 세포치료제, 이중특이항체, ADC(항체-약물 접합체) 등 최신 바이오의약품은 이 분류체계에 매칭되지 않는 경우가 많다.

**데이터 흐름 추적:**

```
Stream 1 FDA search (pharm_class_epc)
  → CAR-T/bispecific 미검색 (pharm_class 매칭 안됨)
  → fda_data = None

Stream 1 EMA filter (therapeutic_area text match)
  → CAR-T/bispecific 검색됨 (therapeutic_area 텍스트 매칭)
  → ema_data = {...}

orchestrator.merge_results()
  → drug = {fda_data: None, ema_data: {...}}

orchestrator.build_global_statuses()
  → build_from_fda_ema(fda_data=None, ema_data={...})
  → status.fda = None  ← FDA RegulatoryApproval 생성 안됨
  → status.ema = RegulatoryApproval(status=APPROVED)

DomesticImpactAnalyzer.analyze()
  → impact.fda_approved = False  ← 잘못된 결과
  → impact.ema_approved = True

DBLoader._upsert_events()
  → FDA 이벤트 미생성
  → EMA 이벤트만 생성
```

### 부차 원인: 승인 날짜 누락

FDA/EMA 이벤트의 95%+ 가 `approval_date = NULL`.

- **FDA**: `submission_status_date` 필드가 `fda_data`에 없음 (Therapeutic stream의 pharm_class 검색 결과에 포함 안됨). Innovation stream의 NME 검색만 이 필드 포함.
- **EMA**: `marketing_authorisation_date` 필드가 EMA JSON에 포함되지만, `_build_ema_approval()`의 날짜 파싱 형식(`%Y-%m-%d`)과 실제 데이터 형식 불일치 가능성.

### 부차 원인: 스크립트 필드명 오류 (수정 완료)

`compare_models.py`, `publish_articles.py`에서 DB 이벤트 읽을 때 필드명 3개 틀림:
- `ev.agency == "FDA"` → `"fda"` (소문자)
- `ev.event_type` → `ev.status` (컬럼명 다름)
- `ev.event_date` → `ev.approval_date` (컬럼명 다름)
- `GlobalRegulatoryStatus`에 직접 `fda_approved` 속성 할당 → `RegulatoryApproval` 객체 생성으로 수정

### 해결 방안

**Phase 1: FDA 교차참조 보강** (구현 예정)

Stream 1 수집 완료 후, EMA에서만 발견된 약물을 FDA `generic_name`으로 교차 검색:

```
EMA에서 수집된 약물 (453건)
  └─ FDA 미매칭 (366건)
      └─ FDA generic_name 검색
          └─ fda_data 보강
              └─ submission_status_date로 승인 날짜 확보
```

**Phase 2: EMA 승인 날짜 보강**

EMA JSON의 날짜 필드 파싱 로직 점검 및 다중 형식 지원.

### 영향 범위

| 항목 | 현재 | 수정 후 예상 |
|------|------|-------------|
| FDA 이벤트 보유율 | 31% | 60-70% |
| score>=40 FDA 반영 | 2/18건 | 15/18건+ |
| 승인 날짜 보유 | 3.2% | 40-60% |
| 기사 헤드라인 정확도 | 낮음 | 대폭 개선 |

---

## 수정 완료: FDA 교차참조 + EMA 날짜 파싱

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `regscan/ingest/fda.py` | `search_by_generic_name()`, `search_by_substance_name()` 메서드 추가 |
| `regscan/stream/therapeutic.py` | `_enrich_with_fda_crossref()` — EMA-only 약물을 FDA generic_name/substance_name으로 교차검색 |
| `regscan/map/global_status.py` | EMA 날짜 파싱 다중 형식 지원 (`DD/MM/YYYY`, `YYYY-MM-DD`, `YYYYMMDD`), EMA status 필드 다중 감지 |

### 결과 비교

| 지표 | Before | After | 변화 |
|------|--------|-------|------|
| FDA 이벤트 | 217 (31%) | 335 (41%) | +118 (+54%) |
| EMA 이벤트 | 453 (65%) | 569 (70%) | +116 |
| FDA 승인날짜 | 12건 | 133건 | **11x** |
| EMA 승인날짜 | 12건 | 227건 | **19x** |
| score>=40 FDA | 2/18 (11%) | 25/41 (61%) | 대폭 개선 |

### 기사 재발행

- 20건 HTML 기사 재생성 (GPT-4o-mini)
- **16/20건 FDA+EMA 양쪽 승인 보유** (기존 2/18 → 16/20)
- FDA 미반영 4건: CAR-T/세포치료제 (openFDA drugsfda.json 미등재)
- 헤드라인에 "FDA·EMA 승인", "글로벌 승인 완료" 정확 반영
- **결과물**: `output/briefings/` 20건 HTML + `hot_issues_2026-02-13.json`

### 알려진 한계

- openFDA `drugsfda.json`에 BLA(생물학적 제제) 미등재 약물: tisagenlecleucel, axicabtagene ciloleucel, brexucabtagene autoleucel, dorocubicel
- 복합성분명에 세미콜론 포함 시 FDA API 400 Bad Request (e.g. `pertuzumab;trastuzumab`)

---

## 기사 품질 v2.0 개선

### 문제 진단 (Gemini 분석)

| 문제 | 근본 원인 |
|------|-----------|
| 앵무새 반복 | LLM 입력이 규제 상태만 — 차별화 불가 |
| 맥락 부재 | 치료영역·경쟁약·적응증 미전달 |
| 전망 부재 | 타임라인 예측 데이터 없음 + 프롬프트가 예측 미요구 |

### Phase B: 데이터 보강 (완료)

| 파일 | 변경 |
|------|------|
| `regscan/report/llm_generator.py` | `_prepare_drug_data()` 확장 — therapeutic_areas, competitors, indication, days_since_global_approval, mfds_timeline_estimate, quadrant, korea_relevance 추가 |
| `regscan/report/llm_generator.py` | `_estimate_mfds_timeline()` 신규 — 경과일 기반 MFDS 허가 타임라인 예측 텍스트 생성 |
| `regscan/report/llm_generator.py` | `max_tokens` 2000→3000 증가 |
| `regscan/scripts/publish_articles.py` | `load_drugs_from_db()` 확장 — 경쟁약 DB 조회(therapeutic_area별 top 5), 적응증 텍스트(EMA/MFDS raw_data에서 추출) |

### Phase A: 프롬프트 v2.0 (완료)

| 파일 | 변경 |
|------|------|
| `regscan/report/prompts.py` | 전면 재작성 — Prompt Engineering Guide 기법 적용 |

**적용 기법:**
- **Persona**: "메드클레임 인사이트 수석 기자" + 독자 타겟(약제팀장, 보험심사자)
- **Few-Shot 3종**: 긍정형(PEMBROLIZUMAB), 경고형(POLATUZUMAB), 탐색형(SELADELPAR) — 데일리팜 실제 기사 참고
- **CoT 내부 추론**: 약물 정체성→뉴스 앵글→경쟁 지형→타임라인→메드클레임 5단계
- **Anti-Pattern**: "모니터링 필요" 등 5개 금지 표현 + 구체적 대안 제시
- **섹션 역할 재정의**: global=뉴스리드+경쟁분석, domestic=타임라인예측, medclaim=실무가이드
- **Domain Knowledge**: 규제 프로세스 타임라인(FDA→MFDS 1~3년, GIFT 등) 주입

### Phase C: 추후 할 일

- [ ] ClinicalTrials.gov 상세 결과 수집 (resultsSection — ORR, PFS 등)
- [ ] 약가 시뮬레이션 (동일 area 기존 급여 약물 가격 통계 기반)
- [ ] 뉴스 소스 크롤링 (PubMed RSS, FDA Press Release)

---

## 기사 v2.1: EMA 적응증 실시간 주입 (Critical Fix)

### 문제

v2.0 기사 5건 중 3건이 **적응증/기전 사실관계 오류**:
- ZANIDATAMAB-HRII: HER2+ 담관암인데 "DLBCL CDO20 항체"로 기술
- TALQUETAMAB: 다발성 골수종인데 "B세포 림프종 ADC"로 기술
- ZOLBETUXIMAB: CLDN18.2+ 위암인데 "특정 종양" 모호

### 근본 원인

1. **DB raw_data = NULL** (975건 전부) — DBLoader가 raw_data를 저장한 적 없음
2. **therapeutic_areas = "oncology"** (5건 전부) — 너무 광범위하여 경쟁약 구분 불가
3. **FDA 생물학적 제제 접미사** (`-hrii`, `-tgvs` 등) — EMA INN과 불일치

### 수정

| 파일 | 변경 |
|------|------|
| `regscan/scripts/publish_articles.py` | `_fetch_ema_indication_index()` 신규 — EMA API 1회 호출로 1701건 INN→적응증 인덱스 구축 |
| `regscan/scripts/publish_articles.py` | 적응증 주입: EMA API 우선 → DB raw_data 폴백 |
| `regscan/scripts/publish_articles.py` | FDA 접미사 폴백: `zanidatamab-hrii` → `zanidatamab` |
| `regscan/scripts/publish_articles.py` | `pharmacotherapeutic_group` 주입 (기전 정보) |
| `regscan/report/llm_generator.py` | `pharmacotherapeutic_group` 필드 LLM 입력에 추가 |
| `regscan/stream/therapeutic.py` | `therapeutic_indication` 필드를 ema_data에 추가 (향후 파이프라인용) |

### 결과

| 약물 | v2.0 | v2.1 |
|------|------|------|
| POLATUZUMAB VEDOTIN | A (DLBCL, CD79b) | A (유지) |
| ZANIDATAMAB-HRII | **F** (DLBCL, CD20) | **A** (HER2+ 담관암) |
| ZOLBETUXIMAB | **D** ("특정 종양") | **A** (CLDN18.2+ HER2- 위암) |
| IVOSIDENIB | B (EMD-AML) | **A** (IDH1 R132 AML + 담관암) |
| TALQUETAMAB | **F** (B세포 림프종 ADC) | **B+** (다발성 골수종) |

**적응증 정확도: 2/5 → 5/5**

---

## 다음 할 일

- [x] FDA generic_name 교차참조 구현 (therapeutic stream)
- [x] EMA 승인 날짜 파싱 개선
- [x] 기사 재발행 및 품질 검증
- [x] 기사 품질 v2.0 — 데이터 보강 (Phase B)
- [x] 기사 품질 v2.0 — 프롬프트 리팩토링 (Phase A)
- [x] 기사 v2.1 — EMA 적응증 실시간 주입 + 접미사 폴백
- [ ] DBLoader raw_data 저장 (DomesticImpact 구조 변경 필요)
- [ ] 복합성분명(세미콜론) FDA 검색 개선
- [ ] Gemini 결제 설정 후 3-model 재비교
- [ ] Phase 1 나머지 Task (DB therapeutic_areas 세분화, Stream 3 매칭, Breakthrough 404)
