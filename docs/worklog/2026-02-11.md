# 작업일지 - 2026-02-11

## 오늘의 고민: 수집 기준 정리

### 문제 인식

v2.0 구현은 끝났는데, 실제 돌려보면 **대부분 "데이터 없음" 기사**가 나옴.
원인은 약물 카탈로그 전수 발행 방식 — 134개 약물 전부에 기사를 만드니 MFDS-only OTC까지 AI 파이프라인을 태움.

**원래 기획 의도**: 여러 소스를 종합해야만 알 수 있는 인사이트를 의료 현장에 전달
**현실**: 전수 기사 → 저점 약물은 데이터 자체가 없어서 의미 없는 기사 양산

### 방향 결정: 이벤트 기반 발행

카탈로그식 전수 → **변경 감지 기반 선별 발행**으로 전환.

```
[매일 수집] FDA/EMA/MFDS/HIRA 변경 감지
     ↓
[이벤트 필터] "이번 주에 뭐가 바뀌었나?" → 변경된 약물만 추출
     ↓
[4대 스트림 보강] 해당 약물의 bioRxiv/시장/전문가 데이터 수집
     ↓
[AI 파이프라인] Reasoning → Verify → Write (변경 약물만)
     ↓
[기사 발행] 이벤트 맥락 + 종합 분석
```

### 점수 체계 복기 (까먹을까봐 정리)

`regscan/map/global_status.py`의 `HotIssueScorer`가 계산. 최대 100점.

| 카테고리 | 항목 | 점수 |
|----------|------|------|
| FDA | 승인 +10, Breakthrough +15, Accelerated +10, Priority +5, Fast Track +5 |
| EMA | 승인 +10, PRIME +15, Accelerated +10, Conditional +5 |
| MFDS | 승인 +5, 희귀의약품 +10 |
| 다국가 | 3개국+ 승인 +10, 4개국 +10(추가), FDA+EMA 동시승인 +10 |
| 특수 | 희귀의약품 +15, WHO 필수의약품 +10 |
| 질환 | 주요 질환(암/치매/당뇨 등) +10 |

**등급:**
- HOT (80+) / HIGH (60-79) / MID (40-59) / LOW (<40)

---

## 작업 내역

### 수집 기준 상수화 + 파이프라인 필터링 구현

3개 기준선 도입:

| 상수 | 값 | 용도 |
|------|-----|------|
| `MIN_SCORE_FOR_DB` | 10 | DB 적재 최소 점수 (MFDS-only OTC 제외) |
| `MIN_SCORE_FOR_BRIEFING` | 40 | v1 LLM 브리핑 대상 |
| `MIN_SCORE_FOR_AI_PIPELINE` | 40 | v2 AI 파이프라인 대상 |

**변경 파일:**

| 파일 | 변경 |
|------|------|
| `regscan/config/settings.py` | 3개 상수 추가 |
| `regscan/batch/pipeline.py` | Step 4: 10점 미만 DB 적재 차단, Step 5: 하드코딩 40→설정 참조, Step 5.5+v2: 하드코딩 60→설정 참조 (4곳) |
| `scripts/generate_sample_briefing.py` | 하드코딩 `DRUG_IDS=[18,49,28]` 제거 → DB에서 score>=40 동적 조회, `--min-score` CLI 옵션 |
| `scripts/cleanup_low_score.py` | 신규: 저점 약물 정리 (dry-run 기본, `--execute`로 실삭제, CASCADE FK 활용) |

**테스트:** 89/89 통과

---

## 이슈 / 미결 사항

### 1. AI 파이프라인 기준선 40 vs 60
- 원래 AI 파이프라인은 `min_score=60` (HIGH 이상만)이었음
- 플랜에서 40으로 내림 → MID 등급도 AI 기사 대상
- **근거**: 40점이면 FDA+EMA 동시승인 수준, 충분히 기사 가치 있음
- **리스크**: 대상 약물 수 늘어남 → API 비용 증가 가능
- 운영하면서 조정 필요

### 2. 이벤트 트리거 미구현
- 오늘은 **점수 기반 필터링**만 구현
- "이번 주에 뭐가 바뀌었나?" 이벤트 감지 로직은 아직 없음
- 현재 흐름: 매일 전수 스캔 → 점수 필터 → AI
- 목표 흐름: 매일 전수 스캔 → **변경 감지** → 변경 약물만 AI
- 이건 다음 단계에서 구현

### 3. 기존 저점 데이터 정리
- `cleanup_low_score.py`는 만들어놨지만 아직 실행 안 함
- 집에서 dry-run 확인 후 실행할 것

---

## 다음 할 일

- [ ] `python scripts/cleanup_low_score.py` dry-run 확인 → 실행
- [ ] 이벤트 트리거 설계: 수집 시점에 "이전 대비 변경" 감지하는 로직
  - regulatory_events 테이블에 new/changed 플래그?
  - 또는 scan_snapshots 비교?
- [ ] AI 파이프라인 기준선 (40 vs 60) 실 운영 후 조정
- [ ] v2 소스 (ASTI/Health.kr/bioRxiv) 실 연동 테스트
- [ ] 대시보드 UI에 "이번 주 변경 약물" 뷰 추가 검토
