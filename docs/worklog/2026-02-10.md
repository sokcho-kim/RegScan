# 작업일지 - 2026-02-10

## 작업 내역

### v2.0 통합 아키텍처 전체 구현

v1 파이프라인을 깨지 않으면서 3개 신규 데이터 소스 + 3단 AI 파이프라인을 추가하는 v2.0 전체 구현 완료.
모든 v2 기능은 `ENABLE_*` 플래그로 토글 가능하여 기존 운영에 영향 없음.

---

### Phase 1: DB 스키마 v2 (신규 테이블 5개)

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/db/models.py` | 수정 | 5개 신규 ORM 모델 + DrugDB에 v2 relationship 5개 |
| `regscan/db/v2_loader.py` | 신규 | V2Loader 클래스 (upsert 5종 + 헬퍼) |

**신규 테이블:**

| 테이블 | 용도 | unique key |
|--------|------|------------|
| `preprints` | bioRxiv/medRxiv 논문 | doi |
| `market_reports` | ASTI/KISTI 시장 리포트 | (drug_id, source, title) |
| `expert_opinions` | Health.kr 전문가 리뷰 | (drug_id, source, title) |
| `ai_insights` | AI 추론+검증 결과 | append only (이력 보존) |
| `articles` | GPT-5.2 기사 | (drug_id, article_type) |

---

### Phase 2: Settings 확장 + AI 디렉토리

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/config/settings.py` | 수정 | v2 설정 14개 추가 |
| `.env.example` | 수정 | v2 환경변수 예시 |
| `regscan/ai/__init__.py` | 신규 | AI Intelligence Layer 패키지 |

**신규 설정:**
```
GEMINI_API_KEY, ENABLE_GEMINI_PARSING, GEMINI_MODEL
ENABLE_AI_REASONING, REASONING_MODEL=o4-mini
ENABLE_AI_VERIFIER, VERIFIER_MODEL=gpt-5.2
ENABLE_AI_WRITER, WRITER_MODEL=gpt-5.2
MAX_REASONING_CALLS_PER_DAY=50, MAX_WRITER_CALLS_PER_DAY=50
ENABLE_ASTI, ENABLE_HEALTHKR, ENABLE_BIORXIV
```

---

### Phase 3: ASTI 수집기 + 파서

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/ingest/asti.py` | 신규 | ASTIClient(Playwright) + ASTIIngestor |
| `regscan/parse/asti_parser.py` | 신규 | ASTIReportParser (시장규모/성장률 자동추출) |

- Playwright 기반 크롤링 (HIRA/MOHW 패턴 동일)
- 키워드: 의약품, 바이오, 제약, 신약
- 시장 규모(억원), 성장률(%) 정규식 추출

---

### Phase 4: Health.kr 수집기 + 파서

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/ingest/healthkr.py` | 신규 | HealthKRClient(Playwright) + HealthKRIngestor |
| `regscan/parse/healthkr_parser.py` | 신규 | HealthKRParser |

- 검색 → drug_cd 추출 → KPIC/약사저널 섹션 파싱
- 핫이슈 약물명 기준으로 상위 3건만 수집 (비용 절감)

---

### Phase 5: bioRxiv 수집기 + 파서

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/ingest/biorxiv.py` | 신규 | BioRxivClient(REST API) + BioRxivIngestor |
| `regscan/parse/biorxiv_parser.py` | 신규 | BioRxivParser |

- REST API 기반 (`api.biorxiv.org/details/{server}/{interval}`)
- 키워드 필터링 (bioRxiv API가 검색을 지원 안 해서 전체수집 후 필터)
- biorxiv + medrxiv 양쪽 수집
- PDF URL 자동 구성

---

### Phase 6: Gemini PDF 파서

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/ai/gemini_parser.py` | 신규 | GeminiParser (PDF→구조화데이터) |
| `pyproject.toml` | 수정 | `[gemini]` optional 의존성 추가 |

- PDF URL → 다운로드 → Gemini API → JSON 추출
- 약물명/적응증/MOA/연구결과 자동 추출 프롬프트
- MD5 해시 기반 메모리 캐시 (동일 PDF 재파싱 방지)
- 핫이슈(score>=60) 논문만 선택 파싱 (비용 절감)

---

### Phase 7: 3단 AI 파이프라인 (핵심)

```
[o4-mini] Reasoning → [GPT-5.2] Verifier → [GPT-5.2] Writer
```

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/ai/reasoning_engine.py` | 신규 | ReasoningEngine (o4-mini, reasoning_effort=high) |
| `regscan/ai/verifier.py` | 신규 | InsightVerifier (GPT-5.2, temperature=0.2) |
| `regscan/ai/writing_engine.py` | 신규 | WritingEngine (GPT-5.2, temperature=0.7) |
| `regscan/ai/pipeline.py` | 신규 | AIIntelligencePipeline 오케스트레이터 |
| `regscan/ai/prompts/reasoning_prompt.py` | 신규 | 4대 스트림 CoT 분석 프롬프트 |
| `regscan/ai/prompts/verifier_prompt.py` | 신규 | 팩트체크 검증 프롬프트 |
| `regscan/ai/prompts/writer_prompt.py` | 신규 | Few-Shot 기사 작성 프롬프트 |

**안전장치:**
- 각 단계 실패 시 fallback (기존 v1 점수/템플릿)
- 일일 API 호출 제한 (MAX_*_CALLS_PER_DAY)
- 각 단계 ENABLE_* 플래그로 독립 토글

**기사 유형:** briefing / newsletter / press_release

---

### Phase 8: 배치 파이프라인 통합

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/batch/pipeline.py` | 수정 | 6단계 → 9단계 확장 |
| `regscan/scheduler.py` | 수정 | v2 파이프라인 단계 추가 |

**파이프라인 단계 (신규 3개):**
```
기존 6단계 유지 +
[4.5] 신규 소스 수집 (ASTI/Health.kr/bioRxiv) — ENABLE_* 체크
[4.6] Gemini PDF 파싱 — ENABLE_GEMINI_PARSING 체크
[5.5] AI 3단 파이프라인 — ENABLE_AI_* 체크, score>=60 핫이슈만
```

---

### Phase 9: API 확장

| 파일 | 변경 | 설명 |
|------|------|------|
| `regscan/api/routes/drugs.py` | 수정 | 엔드포인트 4개 추가 |
| `regscan/api/schemas.py` | 수정 | 응답 스키마 5개 추가 |

**신규 엔드포인트:**

| 엔드포인트 | 설명 |
|-----------|------|
| `GET /api/v1/drugs/{inn}/insight` | AI 추론·검증 결과 |
| `GET /api/v1/drugs/{inn}/article?article_type=briefing` | AI 기사 |
| `GET /api/v1/drugs/{inn}/preprints` | 프리프린트 논문 |
| `GET /api/v1/drugs/{inn}/market` | 시장 리포트 |

---

### Phase 10: 테스트

| 파일 | 테스트 수 | 설명 |
|------|----------|------|
| `tests/test_v2_schema.py` | 7 | 테이블 생성, CRUD 5종, relationship |
| `tests/test_ai_pipeline.py` | 9 | 3단 엔진 fallback, 파이프라인, 포맷터 |
| `tests/test_v2_pipeline.py` | 13 | 파서 3종, 설정 기본값, 임포트 검증 |

**결과:**
```
29 passed, 0 failed (v2 신규)
52 passed, 1 failed (전체 — 기존 test_fda.py 인코딩 버그, v2 무관)
```

---

## 파일 변경 요약

### 신규 생성 (20개)
```
regscan/ai/__init__.py
regscan/ai/gemini_parser.py
regscan/ai/reasoning_engine.py
regscan/ai/verifier.py
regscan/ai/writing_engine.py
regscan/ai/pipeline.py
regscan/ai/prompts/__init__.py
regscan/ai/prompts/reasoning_prompt.py
regscan/ai/prompts/verifier_prompt.py
regscan/ai/prompts/writer_prompt.py
regscan/ingest/asti.py
regscan/ingest/healthkr.py
regscan/ingest/biorxiv.py
regscan/parse/asti_parser.py
regscan/parse/healthkr_parser.py
regscan/parse/biorxiv_parser.py
regscan/db/v2_loader.py
tests/test_v2_schema.py
tests/test_v2_pipeline.py
tests/test_ai_pipeline.py
```

### 수정 (8개)
```
regscan/db/models.py
regscan/config/settings.py
regscan/ingest/__init__.py
regscan/batch/pipeline.py
regscan/scheduler.py
regscan/api/routes/drugs.py
regscan/api/schemas.py
pyproject.toml
.env.example
```

---

## 이슈 해결

### 1. 비동기 세션 테스트 이슈
- **문제:** `test_all_tables_created`에서 `engine.connect()` 비동기 프로토콜 에러
- **해결:** 별도 engine 생성 후 `engine.begin()` 사용

### 2. Lazy loading 이슈
- **문제:** `test_drug_v2_relationships`에서 async 세션의 lazy load 실패
- **해결:** `selectinload()` eager loading 적용

---

## 다음 할 일

- [ ] 실제 OPENAI_API_KEY 설정 후 AI 파이프라인 E2E 테스트
- [ ] GEMINI_API_KEY 설정 후 PDF 파싱 테스트
- [ ] Playwright 설치 후 ASTI/Health.kr 수집 실 테스트
- [ ] bioRxiv API 연동 실 테스트
- [ ] 프로덕션 PostgreSQL에서 v2 테이블 마이그레이션
- [ ] 대시보드 UI에 v2 데이터 (인사이트/기사) 표시 추가

---

## 비용 전략 메모

| 역할 | 모델 | 비용 (1M tokens) | 호출 빈도 |
|------|------|------------------|-----------|
| Reasoning | o4-mini (high) | ~$1.10 | 매일, 핫이슈만 (score>=60) |
| Verifier | GPT-5.2 | ~$1.75 | 매일, 핫이슈만 |
| Writer | GPT-5.2 | ~$1.75 | 매일, 핫이슈만 |
| PDF Parser | Gemini | ~$0.05/건 | 신규 논문만 |

예상 월간 비용: 핫이슈 ~50건 기준 약 $30-50 (₩40,000-65,000)
