# RegScan 품질 개선 리포트 (2026-02-06)

## 요약

| 구분 | 수치 |
|------|------|
| 수정 파일 | 10개 |
| 신규 파일 | 2개 |
| 삽입/삭제 | +111 / -21 lines |
| CRITICAL 해결 | 2건 (서버 시작 불가 차단) |
| HIGH 해결 | 4건 (런타임 크래시 방지) |
| MEDIUM 해결 | 4건 (로깅/보안) |

---

## 1. 신규 기능: APScheduler 일간 파이프라인

### 변경 파일
- `regscan/scheduler.py` (신규)
- `regscan/api/routes/scheduler.py` (신규)
- `regscan/api/main.py` (수정)
- `regscan/config/settings.py` (수정)
- `pyproject.toml` (수정)

### 내용
매일 지정 시간(기본 08:00)에 일간 스캔 파이프라인을 자동 실행하는 스케줄러를 구현했다.

**파이프라인 흐름:**
```
DailyScanner.scan(days_back=7)
  → scan_{date}.json 저장
  → HTML 뉴스레터 생성
  → DataStore 리로드 (API 데이터 갱신)
```

**API 엔드포인트:**
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/v1/scheduler/status` | 스케줄러 상태, 다음/마지막 실행 정보 |
| POST | `/api/v1/scheduler/run-now` | 즉시 파이프라인 실행 (백그라운드) |

**설정값 (settings.py / .env):**
| 키 | 기본값 | 설명 |
|----|--------|------|
| `SCHEDULER_ENABLED` | `True` | 스케줄러 활성화 |
| `DAILY_SCAN_HOUR` | `8` | 실행 시각 (시) |
| `DAILY_SCAN_MINUTE` | `0` | 실행 시각 (분) |
| `SCAN_DAYS_BACK` | `7` | 스캔 범위 (일) |
| `GENERATE_BRIEFING` | `True` | 브리핑 자동 생성 |
| `GENERATE_HTML` | `True` | HTML 뉴스레터 생성 |

**검증 결과:**
```
POST /api/v1/scheduler/run-now → 8.5초 완료
  FDA 17건, EMA 14건, MFDS 7건, 핫이슈 15건
  scan_2026-02-06.json + daily_briefing_2026-02-06.html 생성 확인
```

---

## 2. CRITICAL 수정: 서버 시작 차단 이슈

### 2-1. 누락 의존성 — pandas
- **파일**: `pyproject.toml`
- **증상**: `regscan/map/matcher.py`가 `import pandas`하나 pyproject.toml에 미등록 → 서버 시작 시 `ModuleNotFoundError`
- **수정**: `"pandas>=1.5.0"` 추가 (+ `fastapi`, `uvicorn`도 함께 추가)

### 2-2. 하드코딩 파일 경로 — deps.py
- **파일**: `regscan/api/deps.py:39-42`
- **증상**: `approvals_20260203.json` 등 날짜 고정 → 데이터 갱신 시 파일 못 찾아 0건 로드
- **수정**: `_find_latest()` 함수 추가, glob 패턴으로 최신 파일 자동 탐색

**Before:**
```python
files = {
    "fda": data_dir / "fda" / "approvals_20260203.json",
    "ema": data_dir / "ema" / "medicines_20260203.json",
    ...
}
```

**After:**
```python
def _find_latest(directory: Path, pattern: str) -> Optional[Path]:
    files = sorted(directory.glob(pattern))
    return files[-1] if files else None

files = {
    "fda": _find_latest(data_dir / "fda", "approvals_*.json"),
    "ema": _find_latest(data_dir / "ema", "medicines_*.json"),
    ...
}
```

---

## 3. HIGH 수정: 런타임 크래시 방지

### 3-1. LLM 빈 응답 IndexError — llm_generator.py
- **파일**: `regscan/report/llm_generator.py:207, 217`
- **증상**: Anthropic/OpenAI API가 빈 응답 반환 시 `response.content[0]` 또는 `response.choices[0]`에서 IndexError
- **수정**: 빈 리스트 가드 체크 추가, 빈 문자열 반환 + `logger.warning`

```python
# Anthropic
if not response.content:
    logger.warning("Anthropic API returned empty content list")
    return ""
return response.content[0].text

# OpenAI
if not response.choices:
    logger.warning("OpenAI API returned empty choices list")
    return ""
return response.choices[0].message.content
```

### 3-2. LLM 빈 응답 IndexError — why_it_matters.py
- **파일**: `regscan/scan/why_it_matters.py:191`
- **증상**: 동일 (OpenAI 빈 choices)
- **수정**: `None` 반환 → 기존 폴백 체인(`generate()`의 `if text:` 검사)에 의해 템플릿 방식으로 자동 전환

### 3-3. bare except 절 — daily_scanner.py
- **파일**: `regscan/monitor/daily_scanner.py:400, 582`
- **증상**: `except:`가 `KeyboardInterrupt`, `SystemExit`까지 삼킴 + 파싱 실패 무음
- **수정**:

| 위치 | Before | After |
|------|--------|-------|
| FDA 날짜 (L400) | `except:` | `except (ValueError, TypeError):` + `logger.warning` |
| MFDS 날짜 (L582) | `except:` | `except (ValueError, TypeError):` + `logger.debug` |

MFDS는 4.4만건이므로 `debug` 레벨로 로그 폭탄 방지.

---

## 4. MEDIUM 수정: 로깅/보안 개선

### 4-1. 구조화 로깅 도입 — main.py
- **파일**: `regscan/api/main.py`
- **Before**: `print("Loading data...")`
- **After**: `logging.basicConfig()` + `logger.info()` / `logger.error()`
- 포맷: `2026-02-06 14:08:13 [INFO] regscan.api.main: 데이터 로드 완료: 7469개 약물`

### 4-2. CORS allow_credentials 수정 — main.py
- **파일**: `regscan/api/main.py:63`
- **Before**: `allow_credentials=True` (와일드카드 origin과 함께 사용 시 CSRF 취약)
- **After**: `allow_credentials=False`

### 4-3. 데이터 로드 로깅 — deps.py
- **파일**: `regscan/api/deps.py`
- 각 소스별 로드 성공/실패를 `logger.info` / `logger.warning`으로 출력
- 기존: 파일 없으면 무음 스킵 → 개선: `[DataStore] cris 데이터 파일 없음` 경고

### 4-4. print → logger — ema.py
- **파일**: `regscan/ingest/ema.py:173, 175`
- `print(f"[EMA] Request failed...")` → `logger.error(f"[EMA] Request failed...")`

---

## 5. scheduler.py import 안정성

- **파일**: `regscan/scheduler.py:84-97`
- **문제**: `from scripts.generate_daily_html import generate_daily_html` — `scripts/`가 패키지가 아니라 cwd 의존
- **수정**: `importlib.import_module()` + `settings.BASE_DIR` 기반 동적 import, `sys.path` 임시 추가 후 `finally`로 정리

---

## 6. Cloud Run + PostgreSQL 마이그레이션

### 변경 파일
- `regscan/db/models.py` — 7개 정규화 테이블 (drugs, regulatory_events, hira_reimbursements, clinical_trials, briefing_reports, scan_snapshots, feed_cards)
- `regscan/db/database.py` — async/sync 엔진, 커넥션 풀링, init_db()
- `regscan/db/loader.py` — DBLoader: upsert_impacts(), save_briefing(), load_briefing()
- `regscan/storage/gcs.py` — GCSStorage (GCS_BUCKET 없으면 자동 스킵)
- `regscan/batch/pipeline.py` — Cloud Run Jobs 진입점
- `regscan/api/deps.py` — DataStore: on-demand DB 쿼리 (aget_hot_issues, aget_by_inn 등)
- `regscan/api/main.py` — DB init + is_postgres 분기
- `regscan/config/settings.py` — DATABASE_URL, GCS_BUCKET, is_postgres property
- `Dockerfile`, `Dockerfile.web`, `docker-compose.yml` — 컨테이너화

### 내용
JSON 파일 + SQLite 기반에서 Cloud SQL PostgreSQL + GCS 서버리스로 전환.
- `settings.is_postgres` True → DB 모드 (asyncpg), False → 기존 JSON 모드
- DataStore: PG 모드에서 async 메서드(`aget_*`)로 on-demand 쿼리
- 브리핑 저장: DB 우선, 파일 폴백

---

## 7. LLM 브리핑 프롬프트 개선 및 전체 재생성

### 변경 파일
- `regscan/report/prompts.py` — BRIEFING_REPORT_PROMPT 전면 개선
- `regscan/api/routes/dashboard.py` — fallback 브리핑 생성 로직 추가
- `regscan/api/templates/briefing.html` — 날짜 포맷 수정
- `regscan/report/llm_generator.py` — _generate_fallback() 기사톤 템플릿

### 프롬프트 개선 내용
| 항목 | Before | After |
|------|--------|-------|
| 약물 지식 | "데이터에 없으면 정보 없음" | LLM 의약학 지식으로 적응증·기전 포함 |
| 섹션 길이 | 2~3문장 | 최소 4~6문장 |
| 톤 | 사실 나열 | 분석적 기사체 |
| Few-Shot 예시 | 얕은 요약 | 기전·경쟁약물·산정특례 분석 포함 |
| CoT 단계 | 3단계 (승인→국내→메드클레임) | 4단계 (약물 프로파일→승인→국내→메드클레임) |

### 브리핑 생성 결과
- **133개 약물** (hot issues 118 + imminent 15) 전체 LLM 재생성 완료
- 모델: gpt-4o-mini, 소요시간: 약 26분
- `output/briefings/` — 134개 JSON 파일

### 한계 및 향후 과제
- gpt-4o-mini 한계로 일부 적응증 오류 있음 (ex: 교원육종→실제 DLBCL)
- 형식이 동일한 틀에 갇힘 — 약물별 특성에 맞는 다양한 기사 구조 필요
- gpt-4o 또는 claude로 업그레이드 시 품질 향상 기대

---

## 8. 잔여 이슈 (LOW — 추후 처리)

| 이슈 | 파일 | 비고 |
|------|------|------|
| docstring 내 print() | daily_scanner.py, llm_generator.py 등 | 예시 코드이므로 무해 |
| 라우트 리턴 타입힌트 누락 | main.py, scheduler.py routes | FastAPI 동작에 영향 없음 |

---

## 7. 변경 파일 목록

### 수정 (10)
```
pyproject.toml                    +4
regscan/config/settings.py        +8
regscan/api/main.py               +45 -6
regscan/api/deps.py               +30 -6
regscan/ingest/ema.py             +7 -2
regscan/monitor/daily_scanner.py  +6 -2
regscan/report/llm_generator.py   +6
regscan/scan/why_it_matters.py    +4
```

### 신규 (2)
```
regscan/scheduler.py              (스케줄러 코어)
regscan/api/routes/scheduler.py   (스케줄러 API 라우트)
```
