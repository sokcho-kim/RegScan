# 작업일지 - 2026-02-03

## 오늘의 목표

### 1. 글로벌 규제기관 API 조사
- [x] EMA Open Data Portal 조사
- [x] WHO ATC/EML 데이터 조사
- [x] PMDA 데이터 접근성 조사
- [x] 조사 리포트 작성

### 2. EMA 연동 구현
- [x] `regscan/ingest/ema.py` - EMA API 클라이언트
- [x] `regscan/parse/ema_parser.py` - EMA 데이터 파서
- [x] `scripts/collect_ema.py` - 수집 스크립트
- [x] 연동 테스트 완료

### 3. EMA → FeedCard 변환기
- [x] SourceType에 EMA 타입 추가 (EMA_MEDICINE, EMA_ORPHAN, EMA_SHORTAGE, EMA_SAFETY)
- [x] SignalGenerator에 EMA 처리 로직 추가
- [x] 테스트 완료 (HIGH 3건, MID 1건, LOW 6건 / 샘플 10건)

### 4. GlobalRegulatoryStatus 모델
- [x] `regscan/map/global_status.py` - 글로벌 규제 현황 모델
- [x] HotIssueScorer - 핫이슈 스코어링 시스템
- [x] merge_by_inn - FDA+EMA INN 기반 병합
- [x] 테스트 완료 (Lecanemab: 60점 HIGH)

### 5. DB 저장 로직 구현 (오후)
- [x] `regscan/db/models.py` - SnapshotDB, GlobalStatusDB 모델 추가
- [x] `regscan/db/snapshot_repository.py` - 스냅샷 저장소
- [x] `regscan/db/global_status_repository.py` - GlobalStatus 저장소
- [x] 테스트 완료 (스냅샷 저장/조회, GlobalStatus CRUD)

### 6. 통합 파이프라인 E2E 테스트 (오후)
- [x] `scripts/test_e2e_pipeline.py` - FDA+EMA 통합 파이프라인
- [x] 테스트 완료 (EMA 20건 → FeedCard → DB)

### 7. MVP 리포트 생성기 (오후)
- [x] `regscan/report/generator.py` - 일간/주간 리포트 생성
- [x] 텍스트/마크다운 출력 형식
- [x] 테스트 완료 (일간 12건, 주간 12건)

### 8. WHO ATC 코드 연동 (저녁)
- [x] `regscan/map/atc.py` - ATC 데이터베이스 및 매칭
- [x] GitHub fabkury/atcd 데이터셋 활용 (6,440건)
- [x] INN → ATC 코드 자동 매칭
- [x] 치료 영역 분류 (한글/영문)
- [x] 테스트 완료

### 9. FDA+EMA 통합 리포트 (저녁)
- [x] FDA NDA/BLA 데이터 수집 (1,462건)
- [x] FDA+EMA INN 기준 병합 (2,569건)
- [x] 글로벌 규제 인텔리전스 리포트 생성
- [x] **HIGH 3건, MID 76건 도출 성공**

### 10. MFDS 연동 구현 (심야)
- [x] `regscan/ingest/mfds.py` - MFDS API 클라이언트 (공공데이터포털)
- [x] `regscan/parse/mfds_parser.py` - MFDS 허가정보 파서
- [x] EMA↔MFDS INN 매칭 테스트 (19건/200건 샘플)
- [x] 글로벌 신약 매칭 확인 (키트루다, 옵디보, 오젬픽 등)

### 11. Timeline ML 예측 모델 설계 (심야)
- [x] 회귀 vs 생존분석 검토 → **생존분석 채택**
- [x] 설계 문서 작성: `docs/design/timeline_ml_design.md`
- [x] 예측 표현 원칙 정립: "24개월 내 허가 확률 62%"
- [x] **MFDS 전체 스캔 완료**: 44,035건 수집
- [x] **Timeline 데이터셋 생성**: 5,139건 매칭 (EMA↔MFDS)
- [ ] MFDS 필터링 규칙 설계 (다음 단계)
- [ ] Kaplan-Meier / Cox 모델 개발 (추후)

**Timeline 데이터셋 통계:**
- 전체 매칭: 5,139건
- MFDS 후행 (EMA 먼저): 4,314건
- MFDS 선행 (MFDS 먼저): 824건
- 평균 소요일: 4,070일 (11.2년)
- 출력 파일: `data/ml/timeline_dataset_20260203.csv`

---

## 작업 내역

### 1. EMA 연동 구현 (완료)

| 엔드포인트 | 수집 건수 |
|-----------|----------|
| Medicines | 2,655건 |
| Orphan Designations | 3,138건 |
| Supply Shortages | 74건 |
| DHPC (Safety) | 161건 |

### 2. EMA → FeedCard 변환 (완료)

**샘플 테스트 결과 (10건)**
| Impact | 건수 | 예시 |
|--------|------|------|
| HIGH | 3 | Evrysdi(risdiplam), Lenvima(lenvatinib) |
| MID | 1 | Osvyrti(denosumab) - 바이오시밀러 |
| LOW | 6 | Simponi(golimumab) 등 |

**Impact 분류 기준**
- HIGH: Orphan, Accelerated, PRIME, Advanced Therapy
- MID: Biosimilar, 종양 관련
- LOW: 기타

### 3. GlobalRegulatoryStatus 모델 (완료)

**테스트: Lecanemab (Leqembi)**
```
FDA: approved (2023-07-06), Priority Review
EMA: approved (2025-11-14), PRIME, Accelerated

Global Score: 60 (HIGH)
Reasons: FDA 승인, FDA Priority Review, EMA 승인,
         EMA PRIME, EMA Accelerated, 주요 질환 치료제
```

**스코어링 가중치**
| 항목 | 점수 |
|------|------|
| FDA Breakthrough | +15 |
| EMA PRIME | +15 |
| FDA/EMA 승인 | +10 |
| 희귀의약품 | +15 |
| 3개국+ 승인 | +10 |
| 주요 질환 | +10 |

**FDA+EMA 병합 결과 (최종)**
- 입력: FDA 1,462건 (NDA/BLA) + EMA 2,655건
- 출력: 2,569개 GlobalRegulatoryStatus
- 다중 승인 (FDA+EMA): 347건
- **HIGH 등급: 3건** (Seladelpar, Zanidatamab, Polatuzumab)
- **MID 등급: 76건**

### 4. FDA+EMA 통합 리포트 (완료)

**HIGH 등급 의약품 (60점+)**
| INN | Score | 특징 |
|-----|-------|------|
| Seladelpar Lysine | 65 | FDA+EMA, PRIME, 희귀, 조건부 |
| Zanidatamab-HRII | 60 | FDA+EMA, 희귀, 근접승인 |
| Polatuzumab Vedotin | 60 | FDA+EMA, PRIME |

**MID 상위 의약품 (40-59점)**
- Mirvetuximab Soravtansine (55점)
- Talquetamab (55점)
- Zolbetuximab (55점)
- Elafibranor (50점)

---

## 산출물

```
regscan/ingest/
└── ema.py                          # [NEW] EMA API 클라이언트 (16개 엔드포인트)

regscan/parse/
└── ema_parser.py                   # [NEW] EMA 파서 (Medicine, Orphan, Shortage, DHPC)

regscan/scan/
└── signal_generator.py             # [UPDATE] EMA → FeedCard 변환 로직 추가

regscan/models/
└── feed_card.py                    # [UPDATE] EMA SourceType 추가

regscan/map/
└── global_status.py                # [NEW] GlobalRegulatoryStatus, HotIssueScorer

scripts/
├── collect_ema.py                  # [NEW] EMA 수집 스크립트
├── test_ema_feedcard.py            # [NEW] FeedCard 변환 테스트
├── test_global_status.py           # [NEW] GlobalStatus 테스트
├── test_db_storage.py              # [NEW] DB 저장 테스트
├── test_e2e_pipeline.py            # [NEW] E2E 파이프라인 테스트
└── test_report.py                  # [NEW] 리포트 생성 테스트

regscan/db/
├── models.py                       # [UPDATE] SnapshotDB, GlobalStatusDB 추가
├── snapshot_repository.py          # [NEW] 스냅샷 저장소
└── global_status_repository.py     # [NEW] GlobalStatus 저장소

regscan/report/
├── __init__.py                     # [NEW] 리포트 모듈
└── generator.py                    # [NEW] 일간/주간 리포트 생성

regscan/map/
├── atc.py                          # [NEW] WHO ATC 코드 연동
└── __init__.py                     # [UPDATE] ATC 모듈 추가

data/atc/
└── atc_codes.csv                   # [NEW] ATC 코드 캐시 (6,440건)

output/reports/
├── daily_20260203.md               # [NEW] 일간 리포트
├── weekly_20260203.md              # [NEW] 주간 리포트
├── global_intelligence_20260203_full.md    # [NEW] EMA 단독 리포트
└── fda_ema_intelligence_20260203_1416.md   # [NEW] FDA+EMA 통합 리포트

scripts/
├── generate_full_report.py         # [NEW] EMA 리포트 생성
└── generate_full_report_with_fda.py # [NEW] FDA+EMA 통합 리포트

data/fda/
└── approvals_20260203.json         # [NEW] FDA NDA/BLA 1,462건

data/ema/
├── medicines_20260203.json         # 2,655건
├── orphans_20260203.json           # 3,138건
└── shortages_20260203.json         # 74건

docs/research/
├── 2026-02-03_global_regulatory_api_research.md  # 조사 리포트
├── 2026-02-03_mfds_api_research.md               # [NEW] MFDS API 조사 리포트
└── 2026-02-03_cris_api_research.md               # [NEW] CRIS API 조사 리포트

regscan/ingest/
├── mfds.py                                       # [NEW] MFDS API 클라이언트 (284K건)
└── cris.py                                       # [NEW] CRIS API 클라이언트 (참고용)

regscan/parse/
└── mfds_parser.py                                # [NEW] MFDS 허가정보 파서

docs/design/
└── timeline_ml_design.md                         # [NEW] Timeline ML 예측 모델 설계

scripts/
├── build_timeline_dataset.py                     # [NEW] Timeline 데이터셋 구축 스크립트
├── test_mfds_integration.py                      # [NEW] MFDS 통합 테스트
├── test_mfds_matching.py                         # [NEW] MFDS 매칭 테스트
└── collect_mfds_full.py                          # [NEW] MFDS 전체 수집 스크립트
```

---

## 다음 할 일

### Timeline ML 모델 (우선순위)
- [ ] **1️⃣ MFDS 필터링 규칙 설계** - 신약 판별, 제네릭/재허가 제외
- [ ] **2️⃣ 매칭 로직 고도화** - INN salt/formulation, 조합제 처리
- [ ] **3️⃣ MFDS 전체 수집** - 284K건 스캔 → 신약 필터링
- [ ] **4️⃣ 외부 DB 연동** - DrugBank (feature), openFDA (FDA 기준축)
- [ ] **5️⃣ Kaplan-Meier 분석** - 계열별 생존곡선
- [ ] **6️⃣ Cox 모델 학습** - feature 기반 예측

### 내일 (02-04)
- [ ] MFDS 필터링 규칙 초안 작성
- [ ] 신약 판별 기준 정의 (허가구분, 최초 여부)
- [ ] 매칭 로직 개선 (동의어 사전 확장)

### 이번 주 (Week 6 남은 일정)
- [ ] MFDS 전체 스캔 실행 (백그라운드)
- [ ] FDA 매칭률 측정 및 개선

### 다음 주 (Week 7)
- [ ] DrugBank/ChEMBL feature 연동
- [ ] Kaplan-Meier 분석 및 시각화
- [ ] MedClaim 연동 준비

---

## 메모

- EMA JSON API는 FDA openFDA와 동급 품질
- GlobalRegulatoryStatus로 "이 약이 글로벌에서 어떤 상태인지" 한눈에 파악 가능
- 핫이슈 스코어링으로 자동 우선순위 부여
- WHO ATC 라이선스: 상업적 사용 불가 (비공식 소스 활용 시 주의)

### Timeline ML 핵심 결정사항 (심야)

**예측 방식 결정:**
- ❌ 회귀: "2026년 3월 허가" → 위험 (틀리면 신뢰 박살)
- ✅ 생존분석: "24개월 내 허가 확률 62%" → 안전 + 불확실성 표현

**데이터 전략:**
- MFDS 전체 스캔 = y (정답 레이블), 주력
- 외부 DB (DrugBank, ChEMBL) = x (피처), 보조
- 단독으로 완전한 데이터셋은 없음 → 주력 + 보조 조합

**MFDS 한계:**
- 노이즈 과다 (제네릭, 위탁, 재허가)
- 글로벌 매칭 불완전 (INN 없음, salt 차이)
- 필터링 파이프라인 필수

**현재 데이터:**
- EMA↔MFDS 매칭: 18건 (샘플)
- 평균 소요일: 1,223일 (3.4년)
- MFDS가 EMA보다 먼저인 케이스 존재 (글로벌 임상 참여)
