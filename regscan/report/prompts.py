"""LLM 프롬프트 템플릿

프롬프트 엔지니어링 기법 적용:
- Few-Shot: 좋은 예시 제공
- Chain-of-Thought: 단계별 추론
- 도메인 지식 주입: 의약품 규제/급여 전문 지식
"""

# === 시스템 프롬프트 ===

SYSTEM_PROMPT = """당신은 의약품 규제 전문 기자이자 건강보험 전문가입니다.

## 전문 분야
- FDA/EMA/MFDS 승인 절차 및 규제 동향
- HIRA 급여 심사 및 약가 결정
- 희귀의약품, 항암제, 바이오의약품 급여 정책
- 메드클레임(의료비 청구) 실무

## 작성 원칙
1. 객관적 사실만 기술 - 데이터에 없는 정보 작성 금지
2. 전문 용어 사용하되 명확하게 설명
3. 메드클레임 시사점은 구체적 수치 포함
4. 한국어로 작성, 약물명/기관명은 영문 유지

## 급여 관련 도메인 지식
- 일반 급여: 본인부담 30%
- 희귀질환 산정특례: 본인부담 10%
- 암환자 산정특례: 본인부담 5%
- 고가약제(100만원 이상): 사전심사 대상 가능
- 비급여: 전액 환자부담, 실손보험 청구 가능"""


# === 브리핑 리포트 프롬프트 (Few-Shot + CoT) ===

BRIEFING_REPORT_PROMPT = """아래 약물의 규제 데이터를 분석하여 전문 브리핑 리포트를 작성하세요.

## 입력 데이터 (규제·급여 현황)
{drug_data}

---

## 중요 지침

1. **약물의 의학적 배경을 반드시 포함하세요.**
   - INN(국제일반명)을 보고, 해당 약물의 **적응증, 작용기전(MOA), 약물 분류**를 당신의 의약학 지식으로 작성하세요.
   - 예: PEMBROLIZUMAB → PD-1 면역관문억제제, 흑색종·비소세포폐암 등
   - 예: VENETOCLAX → BCL-2 억제제, 만성림프구성백혈병(CLL) 치료제
   - 이것은 추측이 아닌 공인된 의약학 지식입니다.
2. **규제 데이터(날짜, 가격, 급여 상태)는 입력 데이터에 기반하여 정확히 기술하세요.**
   입력 데이터에 없는 규제 수치(날짜, 가격 등)는 작성하지 마세요.
3. **기사체로 작성하세요.** 단순 사실 나열이 아닌, 맥락과 분석이 담긴 전문 기사입니다.
4. **각 섹션은 최소 4~6문장으로 충실하게 작성하세요.**

---

## 분석 단계 (Chain-of-Thought)

### 1단계: 약물 프로파일
- 이 약물은 어떤 질환에 사용되는가?
- 작용기전(MOA)은 무엇인가?
- 같은 적응증의 경쟁 약물 대비 특장점은?

### 2단계: 글로벌 승인 현황
- FDA/EMA 승인 상황 및 시기
- Breakthrough/Orphan/PRIME/Accelerated 등 특수 지정
- 승인 시기의 의미 (빠른 승인? 지연? 동시 승인?)

### 3단계: 국내 도입 현황
- MFDS 허가 여부 및 제품명
- HIRA 급여 등재 상태
- CRIS 임상시험 현황
- 허가·급여 타임라인 전망

### 4단계: 메드클레임 시사점
- 급여 적용 시: 본인부담률 계산, 고가약제 사전심사
- 비급여 시: 환자 부담, 실손보험 가능성
- 희귀질환/암 산정특례 해당 여부와 구체적 금액

---

## Few-Shot 예시

### 예시 1: 급여 적용 고가 항암제

입력:
```json
{{"inn": "PEMBROLIZUMAB", "fda": {{"approved": true, "date": "2014-09-04"}},
"ema": {{"approved": true, "date": "2015-07-17"}},
"hira": {{"status": "reimbursed", "price": 2103620}}}}
```

출력:
```json
{{
  "headline": "면역항암제 키트루다(PEMBROLIZUMAB), 글로벌 표준치료 지위 확보 — 국내 급여 적용 중",
  "subtitle": "PD-1 면역관문억제제, 다암종 적응증 보유 고가약제로 사전심사 대상",
  "key_points": [
    "PD-1 면역관문억제제로 흑색종·비소세포폐암·두경부암 등 20개 이상 적응증 보유",
    "FDA 2014년 9월, EMA 2015년 7월 승인 — 면역항암 치료 패러다임을 전환한 약물",
    "HIRA 급여 적용, 상한가 약 210만원 — 고가약제 사전심사 대상",
    "일반 급여 시 본인부담 약 63만원(30%), 암환자 산정특례 시 약 10.5만원(5%)"
  ],
  "global_section": "PEMBROLIZUMAB(키트루다)은 머크(MSD)가 개발한 PD-1 면역관문억제제로, 종양세포가 면역회피에 이용하는 PD-1/PD-L1 경로를 차단하여 T세포의 항종양 반응을 회복시킨다. 2014년 9월 FDA로부터 진행성 흑색종 치료제로 첫 승인을 받은 이후, 비소세포폐암(NSCLC), 두경부편평세포암, 요로상피암, 위암, 자궁경부암 등 20개 이상의 적응증으로 확대되었다. 2015년 7월 EMA 승인을 획득하며 글로벌 면역항암 치료의 1차 표준치료제 지위를 확립했다. 현재 전 세계 항암제 매출 1위 약물로, 다수의 병용요법 임상이 진행 중이다.",
  "domestic_section": "국내에서는 MFDS 허가를 받아 '키트루다주'로 시판 중이며, HIRA 급여 목록에 등재되어 건강보험 혜택을 받을 수 있다. 다만 급여 적응증은 글로벌 허가 적응증 대비 제한적으로, 허가 적응증 전체가 급여 대상은 아닌 점에 유의해야 한다. CRIS에 9건의 국내 임상시험이 등록되어 있어, 병용요법 등 추가 적응증에 대한 연구가 활발하다. 비소세포폐암 1차 치료 등 주요 적응증에서는 급여가 적용되나, 일부 암종에서는 비급여 사용이 불가피한 상황이다.",
  "medclaim_section": "HIRA 등재 약제로 상한가는 약 210만원이다. 일반 급여 적용 시 환자 본인부담은 30%인 약 63만원이며, 암환자 산정특례(중증질환 등록) 적용 시 본인부담이 5%인 약 10.5만원으로 대폭 경감된다. 1회 투여 비용이 100만원을 초과하는 고가약제로, 요양기관에서는 사전심사(PA)를 통해 급여 적정성을 확인받아야 한다. 적응증별 급여 기준이 상이하므로, 처방 전 HIRA 고시 기준을 반드시 확인해야 한다."
}}
```

### 예시 2: 국내 미허가 희귀의약품

입력:
```json
{{"inn": "ELRANATAMAB", "fda": {{"approved": true, "date": "2023-08-14"}},
"ema": {{"approved": true, "date": "2023-12-14"}},
"mfds": {{"approved": false}}, "hira": {{"status": null}},
"cris": {{"trial_count": 1}},
"analysis": {{"hot_issue_reasons": ["FDA 승인", "EMA 승인", "희귀의약품"]}}}}
```

출력:
```json
{{
  "headline": "이중특이항체 ELRANATAMAB, FDA·EMA 동시 승인 — 국내 도입 임박",
  "subtitle": "BCMA×CD3 타겟 다발골수종 치료제, 희귀의약품 지정으로 신속 도입 기대",
  "key_points": [
    "BCMA×CD3 이중특이항체로, 재발·불응성 다발골수종의 새로운 치료 옵션",
    "FDA 2023년 8월, EMA 2023년 12월 — 5개월 간격 양대 기관 승인 완료",
    "MFDS 미허가, CRIS 임상 1건 진행 — 국내 허가 신청 임박 가능성",
    "희귀의약품 지정으로 급여 시 산정특례(본인부담 10%) 적용 기대"
  ],
  "global_section": "ELRANATAMAB은 화이자가 개발한 BCMA(B세포 성숙항원)와 CD3를 동시에 표적하는 이중특이항체(bispecific antibody)다. 다발골수종 세포 표면의 BCMA에 결합하는 동시에 T세포의 CD3에 결합하여, T세포를 종양세포로 유도해 직접적인 항종양 효과를 발휘한다. 2023년 8월 FDA가 4차 이상 치료 실패 재발·불응성 다발골수종에 대해 가속승인을 부여했으며, 같은 해 12월 EMA도 조건부 허가를 완료했다. CAR-T 치료와 함께 다발골수종 후기 치료 라인의 새로운 선택지로 주목받고 있다.",
  "domestic_section": "현재 MFDS 허가 전 단계로 국내 정식 처방은 불가능하다. 다만 CRIS에 1건의 임상시험이 등록되어 있어 임상 참여를 통한 약물 접근이 가능하며, 이는 국내 허가 신청의 전 단계로 해석할 수 있다. 글로벌 양대 기관 승인이 완료된 점, 희귀의약품 지정 이력을 고려하면 MFDS 신속심사 대상이 될 가능성이 있다. 허가 후에는 급여 등재 절차(약가 협상)에 통상 6개월~2년이 소요되므로, 환자 접근성 확보까지는 추가 시간이 필요할 전망이다.",
  "medclaim_section": "현재 국내 미허가로 건강보험 급여 적용이 불가하며, 긴급도입 또는 임상시험 참여 외 합법적 처방 경로가 없다. 향후 허가·급여 등재 시, 희귀의약품 지정 약물로서 희귀질환 산정특례(본인부담 10%)가 적용될 가능성이 높다. 다발골수종은 암환자 산정특례(본인부담 5%) 대상 질환이기도 하므로, 이중 산정특례 적용 가능성도 검토할 필요가 있다. 긴급도입 시에는 전액 환자부담이며, 희귀의약품센터(KODC)를 통한 도입 절차를 확인해야 한다."
}}
```

---

## 출력 형식

위 예시와 동일한 JSON 형식으로 출력하세요.

**필수 요구사항:**
- 약물의 적응증과 작용기전을 반드시 포함 (당신의 의약학 지식 활용)
- 각 섹션은 최소 4문장 이상, 분석적 기사체로 작성
- 규제 데이터(날짜, 가격)는 입력 데이터에서 정확히 인용
- 헤드라인에 약물의 치료 영역 또는 기전을 반영

```json
{{
  "headline": "치료 영역/기전 포함 헤드라인 (40자 이내)",
  "subtitle": "핵심 특징 요약 (60자 이내)",
  "key_points": ["의학적 맥락 포인트", "승인 현황 포인트", "급여/가격 포인트", "전망 포인트"],
  "global_section": "약물 프로파일 + 글로벌 승인 현황 (4~6문장)",
  "domestic_section": "국내 허가·급여·임상 현황 + 전망 (4~6문장)",
  "medclaim_section": "보험 청구·본인부담·산정특례 분석 (4~6문장)"
}}
```"""


# === 메드클레임 시사점 전용 프롬프트 ===

MEDCLAIM_INSIGHT_PROMPT = """이 약물의 메드클레임(의료비 청구) 시사점을 분석하세요.

## 약물 정보
{drug_data}

## 분석 프레임워크

단계별로 분석하세요:

### 1단계: 급여 상태 확인
- 급여/삭제/비급여/미등재 중 어디에 해당?
- 급여 기준(적응증 제한) 있는지?

### 2단계: 본인부담금 계산
- 상한가 확인
- 일반 급여: 상한가 × 30%
- 희귀질환 산정특례: 상한가 × 10%
- 암환자 산정특례: 상한가 × 5%

### 3단계: 특이사항 확인
- 고가약제(100만원 이상) 여부 → 사전심사
- 희귀의약품 지정 여부 → 산정특례
- 임상시험 진행 여부 → 약물 접근 경로

### 4단계: 환자 안내사항 정리

## 출력 형식 (JSON)
```json
{{
  "reimbursement_status": "급여 상태 요약",
  "out_of_pocket": {{
    "general": "일반 급여 시 본인부담",
    "special": "산정특례 시 본인부담"
  }},
  "considerations": ["고려사항1", "고려사항2"],
  "patient_guidance": "환자 안내 요약"
}}
```"""


# === 간단 요약 프롬프트 ===

QUICK_SUMMARY_PROMPT = """아래 약물 데이터를 2-3문장으로 요약하세요.

{drug_data}

요약 작성 시:
1. 글로벌 승인 현황 (FDA/EMA)
2. 국내 현황 (MFDS/HIRA)
3. 핵심 시사점

출력: 간결한 한국어 요약 (추측 없이 사실만)"""


# === 모델별 최적화 프롬프트 ===

def get_optimized_prompt(model: str, drug_data: str) -> str:
    """모델에 따른 최적화된 프롬프트 반환

    - gpt-4o-mini: 간결한 지시, JSON 출력 강조
    - gpt-4o: 상세한 CoT, 복잡한 추론
    - claude: 구조화된 XML 태그 활용
    """
    if "gpt-4o-mini" in model or "gpt-3.5" in model:
        # 간결한 프롬프트, 토큰 효율성
        return f"""의약품 브리핑 리포트를 JSON으로 작성하세요.

데이터:
{drug_data}

출력 (JSON만):
{{"headline": "제목", "subtitle": "부제", "key_points": ["1", "2", "3", "4"], "global_section": "글로벌", "domestic_section": "국내", "medclaim_section": "메드클레임"}}"""

    elif "gpt-4" in model or "gpt-5" in model:
        # 상세한 CoT 프롬프트
        return BRIEFING_REPORT_PROMPT.format(drug_data=drug_data)

    else:  # claude 등
        return BRIEFING_REPORT_PROMPT.format(drug_data=drug_data)
